trigger:
- main

variables:
  ACR_NAME: myacr123.azurecr.io
  IMAGE_TAG: $(Build.BuildId)

pool:
  vmImage: ubuntu-latest

stages:

# =========================
# STAGE 1: BUILD (MAVEN)
# =========================
- stage: Build
  displayName: Build Java Services
  jobs:
  - job: MavenBuild
    displayName: Maven Build
    steps:
    - task: Maven@3
      displayName: Build productcatalogue
      inputs:
        mavenPomFile: productcatalogue/pom.xml
        goals: clean package

    - task: Maven@3
      displayName: Build shopfront
      inputs:
        mavenPomFile: shopfront/pom.xml
        goals: clean package

    - task: Maven@3
      displayName: Build stockmanager
      inputs:
        mavenPomFile: stockmanager/pom.xml
        goals: clean package

# =========================
# STAGE 2: DOCKER BUILD & PUSH
# =========================
- stage: Docker
  displayName: Build & Push Docker Images
  dependsOn: Build
  jobs:
  - job: DockerBuildPush
    displayName: Docker Build & Push
    steps:

    - task: Docker@2
      displayName: Build & Push productcatalogue
      inputs:
        containerRegistry: acr-service-connection
        repository: productcatalogue
        command: buildAndPush
        Dockerfile: productcatalogue/Dockerfile
        tags: |
          $(IMAGE_TAG)

    - task: Docker@2
      displayName: Build & Push shopfront
      inputs:
        containerRegistry: acr-service-connection
        repository: shopfront
        command: buildAndPush
        Dockerfile: shopfront/Dockerfile
        tags: |
          $(IMAGE_TAG)

    - task: Docker@2
      displayName: Build & Push stockmanager
      inputs:
        containerRegistry: acr-service-connection
        repository: stockmanager
        command: buildAndPush
        Dockerfile: stockmanager/Dockerfile
        tags: |
          $(IMAGE_TAG)

# =========================
# STAGE 3: HELM DEPLOY TO AKS
# =========================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Docker
  jobs:
  - job: HelmDeploy
    displayName: Helm Upgrade Install
    steps:

    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: latest

    - task: HelmDeploy@0
      displayName: Deploy ecommerce chart
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceConnection: aks-service-connection
        command: upgrade
        chartType: FilePath
        chartPath: helm/ecommerce
        releaseName: ecommerce
        overrideValues: |
          productcatalogue.image.repository=$(ACR_NAME)/productcatalogue
          productcatalogue.image.tag=$(IMAGE_TAG)
          shopfront.image.repository=$(ACR_NAME)/shopfront
          shopfront.image.tag=$(IMAGE_TAG)
          stockmanager.image.repository=$(ACR_NAME)/stockmanager
          stockmanager.image.tag=$(IMAGE_TAG)
